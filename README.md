# Free MQTT Platform

ä¸€ä¸ªåŸºäºSpring Bootå’ŒNettyæ„å»ºçš„é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„MQTTæ¶ˆæ¯ä»£ç†å¹³å°ï¼Œæ”¯æŒé›†ç¾¤éƒ¨ç½²å’Œæ¶ˆæ¯è·¯ç”±ã€‚

## ğŸš€ é¡¹ç›®æ¦‚è¿°

Free MQTT Platformæ˜¯ä¸€ä¸ªå¼€æºçš„MQTTæ¶ˆæ¯ä»£ç†å¹³å°ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œæä¾›é«˜æ€§èƒ½çš„MQTTæ¶ˆæ¯ä¼ è¾“æœåŠ¡ã€‚è¯¥å¹³å°æ”¯æŒé›†ç¾¤éƒ¨ç½²ã€æ¶ˆæ¯è·¯ç”±ã€è´Ÿè½½å‡è¡¡ç­‰ä¼ä¸šçº§ç‰¹æ€§ï¼Œé€‚ç”¨äºIoTè®¾å¤‡é€šä¿¡ã€å®æ—¶æ¶ˆæ¯æ¨é€ç­‰åœºæ™¯ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ¨¡å—ç»“æ„

```
free-mqtt-platform/
â”œâ”€â”€ mqtt-server/          # MQTTæœåŠ¡å™¨æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ netty/            # Nettyç½‘ç»œå¤„ç†
â”‚   â”œâ”€â”€ qos/              # QoSæ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ session/          # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ subscriptions/    # è®¢é˜…ç®¡ç†
â”‚   â”œâ”€â”€ interceptor/      # æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ auth/             # è®¤è¯æˆæƒ
â”‚   â””â”€â”€ web/              # HTTPç®¡ç†æ¥å£
â”œâ”€â”€ mqtt-route/           # æ¶ˆæ¯è·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ web/              # è·¯ç”±æ§åˆ¶æ¥å£
â”‚   â””â”€â”€ service/          # è·¯ç”±æœåŠ¡
â”œâ”€â”€ mqtt-common/          # å…¬å…±ç»„ä»¶æ¨¡å—
â”‚   â”œâ”€â”€ zk/               # ZooKeeperé›†ç¾¤ç®¡ç†
â”‚   â”œâ”€â”€ constant/         # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ resp/             # å“åº”å°è£…
â””â”€â”€ logs/                 # æ—¥å¿—ç›®å½•
```

### æŠ€æœ¯æ¶æ„

- **åº”ç”¨æ¡†æ¶**: Spring Boot 1.5.6
- **ç½‘ç»œæ¡†æ¶**: Netty 4.1.13
- **MQTTåè®®**: åŸºäºNetty MQTTç¼–è§£ç å™¨
- **é›†ç¾¤ç®¡ç†**: ZooKeeper + Curator
- **ç¼“å­˜**: Redis + Redisson
- **æ¶ˆæ¯å¤„ç†**: Vert.xå¼‚æ­¥å¤„ç†
- **æ—¥å¿—**: Log4j2 + SLF4J
- **åºåˆ—åŒ–**: FastJSON
- **HTTPå®¢æˆ·ç«¯**: OkHttp3

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. MQTTåè®®æ”¯æŒ
- æ”¯æŒMQTT 3.1å’Œ3.1.1åè®®
- æ”¯æŒQoS 0/1/2ä¸‰ç§æœåŠ¡è´¨é‡ç­‰çº§
- æ”¯æŒä¿ç•™æ¶ˆæ¯å’Œé—å˜±æ¶ˆæ¯
- æ”¯æŒä¸»é¢˜è®¢é˜…å’Œé€šé…ç¬¦
- æ”¯æŒKeep-Aliveå¿ƒè·³æ£€æµ‹
- æ”¯æŒClean Sessionä¼šè¯ç®¡ç†

### 2. é«˜æ€§èƒ½æ¶ˆæ¯å¤„ç†
- åŸºäºNettyçš„å¼‚æ­¥éé˜»å¡I/O
- å¤šçº¿ç¨‹æ¶ˆæ¯å¤„ç†æ±  (é»˜è®¤CPUæ ¸å¿ƒæ•°Ã—2)
- æ”¯æŒå¤§é‡å¹¶å‘è¿æ¥ (10,000+)
- é«˜æ•ˆçš„æ¶ˆæ¯è·¯ç”±ç®—æ³•
- æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æœºåˆ¶
- å¼‚æ­¥äº‹ä»¶å¤„ç†

### 3. é›†ç¾¤ç®¡ç†
- åŸºäºZooKeeperçš„æœåŠ¡æ³¨å†Œä¸å‘ç°
- è‡ªåŠ¨è´Ÿè½½å‡è¡¡
- é›†ç¾¤èŠ‚ç‚¹ç›‘æ§
- æ•…éšœè‡ªåŠ¨è½¬ç§»
- åŠ¨æ€æœåŠ¡å‘ç°
- é›†ç¾¤çŠ¶æ€åŒæ­¥

### 4. æ¶ˆæ¯è·¯ç”±
- HTTPæ¶ˆæ¯è½¬å‘
- æ¶ˆæ¯æŒä¹…åŒ–
- æ¶ˆæ¯è¿‡æ»¤å’Œæ‹¦æˆª
- æ”¯æŒå¤šç§æ¶ˆæ¯æ ¼å¼
- æ™ºèƒ½è·¯ç”±é€‰æ‹©
- æ¶ˆæ¯TTLè¿‡æœŸæ§åˆ¶

### 5. å®‰å…¨è®¤è¯
- ç”¨æˆ·å/å¯†ç è®¤è¯
- Redis TokenéªŒè¯
- å®¢æˆ·ç«¯IDéªŒè¯
- ä¸»é¢˜æƒé™æ§åˆ¶ (ACL)
- è¿æ¥åŠ å¯†æ”¯æŒ
- ä¼šè¯éš”ç¦»

### 6. æ‰©å±•æ€§
- æ’ä»¶åŒ–æ¶æ„
- æ”¯æŒè‡ªå®šä¹‰æ‹¦æˆªå™¨
- å¯é…ç½®çš„æ¶ˆæ¯å¤„ç†å™¨
- çµæ´»çš„é…ç½®ç®¡ç†
- äº‹ä»¶é©±åŠ¨æ¶æ„
- è‡ªå®šä¹‰æ¶ˆæ¯ç›‘å¬å™¨

### 7. ç›‘æ§å’Œç®¡ç†
- è¿æ¥çŠ¶æ€ç›‘æ§
- æ¶ˆæ¯ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- æ—¥å¿—è®°å½•
- å¥åº·æ£€æŸ¥
- é›†ç¾¤çŠ¶æ€æŸ¥çœ‹

## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚

- **JDK**: 1.8+
- **Maven**: 3.6+
- **Redis**: 3.0+
- **ZooKeeper**: 3.4+
- **æ“ä½œç³»ç»Ÿ**: Windows/Linux/macOS

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®

```bash
git clone  https://github.com/baqqioku/free-mqtt-platform.git

cd free-mqtt-platform
```

### 2. é…ç½®ç¯å¢ƒ

#### é…ç½®Redis
```properties
# mqtt-server/src/main/resources/application.properties
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.password=123
```

#### é…ç½®ZooKeeper
```properties
# é»˜è®¤é…ç½®
zk.address=127.0.0.1
clusterName=default
```

### 3. ç¼–è¯‘é¡¹ç›®

```bash
mvn clean compile
```

### 4. å¯åŠ¨æœåŠ¡

#### å¯åŠ¨MQTTæœåŠ¡å™¨
```bash
cd mqtt-server
mvn spring-boot:run
```

#### å¯åŠ¨æ¶ˆæ¯è·¯ç”±æœåŠ¡
```bash
cd mqtt-route
mvn spring-boot:run
```

### 5. éªŒè¯æœåŠ¡

- MQTTæœåŠ¡å™¨ç«¯å£: 23242 (TCP), 23243 (SSL)
- HTTPç®¡ç†ç«¯å£: 23240
- è·¯ç”±æœåŠ¡ç«¯å£: 8084

## ğŸ”§ é…ç½®è¯´æ˜

### MQTTæœåŠ¡å™¨é…ç½®

```properties
# TCPç«¯å£é…ç½®
tcpPort=23242
tcpSslPort=23243

# é›†ç¾¤é…ç½®
zk.address=127.0.0.1
clusterName=default

# Redisè¿æ¥æ± é…ç½®
spring.redis.pool.max-active=100
spring.redis.pool.max-idle=100
spring.redis.pool.min-idle=10

# çº¿ç¨‹æ± é…ç½®
mqtt.thread.pool.size=50

# æ¶ˆæ¯TTLé…ç½®
mqtt.message.ttl=120000

# é€šé“è¶…æ—¶é…ç½®
mqtt.channel.timeout=180
```

### é›†ç¾¤é…ç½®

```properties
# ZooKeeperé›†ç¾¤åœ°å€
zk.address=zk1:2181,zk2:2181,zk3:2181

# é›†ç¾¤åç§°
clusterName=production

# é›†ç¾¤ç›‘æ§é—´éš”
cluster.monitor.interval=20000
```

### å®‰å…¨é…ç½®

```properties
# è®¤è¯é…ç½®
mqtt.auth.enabled=true
mqtt.auth.redis.key.prefix=USER_STATUS

# ACLé…ç½®
mqtt.acl.enabled=true
mqtt.acl.default.allow=true
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

- **å¹¶å‘è¿æ¥**: æ”¯æŒ10,000+å¹¶å‘è¿æ¥
- **æ¶ˆæ¯åå**: 100,000+ æ¶ˆæ¯/ç§’
- **å»¶è¿Ÿ**: å¹³å‡å»¶è¿Ÿ < 10ms
- **å¯ç”¨æ€§**: 99.9%+ æœåŠ¡å¯ç”¨æ€§
- **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–çš„å†…å­˜ç®¡ç†ï¼Œæ”¯æŒå¤§æ¶ˆæ¯å¤„ç†
- **CPUåˆ©ç”¨ç‡**: å¤šçº¿ç¨‹å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPU
- **ç½‘ç»œI/O**: åŸºäºNettyçš„é«˜æ•ˆç½‘ç»œå¤„ç†
- **æ‰©å±•æ€§**: æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹

## ğŸ”Œ APIæ¥å£

### MQTTå®¢æˆ·ç«¯è¿æ¥

```bash
# è¿æ¥MQTTæœåŠ¡å™¨
mqtt://localhost:23242

# ç”¨æˆ·å/å¯†ç è®¤è¯
username: your_username
password: your_password
```



### æ¶ˆæ¯æ¨é€æ¥å£

```bash
# æœåŠ¡å™¨æ¨é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯
POST http://localhost:23240/pushMsg
Content-Type: application/json

{
    "userId": 2,
    "messageId": 3,
    "ttl": 53,
    "updateTime": 174616022498,
    "data": {
        "msg": "hello",
        "userAo": {
            "userId": 0
        }
    },
    "url": "http://nqozsrqo.pg/aikvtkh"
}
```

### è·¯ç”±æœåŠ¡æ¥å£

```bash
# ç”¨æˆ·æ³¨å†Œ
POST http://localhost:8084/reqister


# ç”¨æˆ·ç™»å½•è·å–MQTTæœåŠ¡å™¨ä¿¡æ¯
POST http://localhost:8084/login

# æ¶ˆæ¯è·¯ç”±æ¨é€
POST http://localhost:8084/pushMsg
```

### æ¥å£ä½¿ç”¨æµç¨‹
```
ç”¨æˆ·ç™»å½•æµç¨‹
-----------------------------------------------------
POST http://localhost:8084/reqister

ç”¨æˆ·æ³¨å†Œè·å–token 
â†“â†“â†“
â†“â†“â†“
POST http://localhost:8084/reqister
ç™»å½•è·å–clientId
â†“â†“â†“
â†“â†“â†“
ç”¨mqttXå·¥å…·è¾“å…¥ç”¨æˆ·åï¼ŒclientId,tokenï¼Œç«¯å£å®è¡Œmqttå®¢æˆ·ç«¯ç™»å½•
-----------------------------------------------------

ç³»ç»Ÿæ¶ˆæ¯æ¨é€

POST http://localhost:8084/pushMsg

å®¢æˆ·ç«¯æ¶ˆæ¯æ¨é€ï¼Œç”¨æ­£å¸¸mqttxå·¥å…·è‡ªè¡Œæ¨¡æ‹Ÿå°±å¯ä»¥

```

## ğŸ”„ è®¿é—®æµç¨‹

### 1. å®¢æˆ·ç«¯è¿æ¥æµç¨‹

```
å®¢æˆ·ç«¯ â†’ MQTTæœåŠ¡å™¨
   â†“
1. å‘é€CONNECTæ¶ˆæ¯
   â†“
2. æœåŠ¡å™¨éªŒè¯ç”¨æˆ·å/å¯†ç 
   â†“
3. éªŒè¯é€šè¿‡ï¼Œè¿”å›CONNACK
   â†“
4. è‡ªåŠ¨è®¢é˜…ä¸ªäººä¸»é¢˜ (/broker/to/client/{userId})
   â†“
5. è¿æ¥å»ºç«‹å®Œæˆ
```

### 2. æ¶ˆæ¯å‘å¸ƒæµç¨‹

```
å‘å¸ƒè€… â†’ MQTTæœåŠ¡å™¨
   â†“
1. å‘é€PUBLISHæ¶ˆæ¯
   â†“
2. æœåŠ¡å™¨éªŒè¯æƒé™ (ACLæ£€æŸ¥)
   â†“
3. æ¶ˆæ¯å­˜å‚¨å’Œè½¬å‘
   â†“
4. æ ¹æ®QoSçº§åˆ«å¤„ç†ç¡®è®¤
   â†“
5. æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…
```

### 3. æ¶ˆæ¯è®¢é˜…æµç¨‹

```
è®¢é˜…è€… â†’ MQTTæœåŠ¡å™¨
   â†“
1. å‘é€SUBSCRIBEæ¶ˆæ¯
   â†“
2. æœåŠ¡å™¨éªŒè¯ä¸»é¢˜æƒé™
   â†“
3. æ·»åŠ åˆ°è®¢é˜…ç›®å½•
   â†“
4. è¿”å›SUBACKç¡®è®¤
   â†“
5. å¼€å§‹æ¥æ”¶ç›¸å…³æ¶ˆæ¯
```

### 4. æœåŠ¡å™¨æ¨é€æµç¨‹

```
HTTPå®¢æˆ·ç«¯ â†’ è·¯ç”±æœåŠ¡ â†’ MQTTæœåŠ¡å™¨
   â†“
1. å‘é€æ¨é€è¯·æ±‚åˆ°è·¯ç”±æœåŠ¡
   â†“
2. è·¯ç”±æœåŠ¡æŸ¥æ‰¾ç”¨æˆ·æ‰€åœ¨MQTTæœåŠ¡å™¨
   â†“
3. è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡MQTTæœåŠ¡å™¨
   â†“
4. MQTTæœåŠ¡å™¨æ¨é€åˆ°å®¢æˆ·ç«¯
   â†“
5. è¿”å›æ¨é€ç»“æœ
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å•æœºéƒ¨ç½²

1. é…ç½®Rediså’ŒZooKeeper
2. ä¿®æ”¹é…ç½®æ–‡ä»¶
3. å¯åŠ¨MQTTæœåŠ¡å™¨å’Œè·¯ç”±æœåŠ¡

### é›†ç¾¤éƒ¨ç½²

1. éƒ¨ç½²ZooKeeperé›†ç¾¤
2. é…ç½®Redisé›†ç¾¤
3. éƒ¨ç½²å¤šä¸ªMQTTæœåŠ¡å™¨èŠ‚ç‚¹
4. é…ç½®è´Ÿè½½å‡è¡¡å™¨

### Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t free-mqtt-platform .

# è¿è¡Œå®¹å™¨
docker run -d -p 23242:23242 -p 23240:23240 free-mqtt-platform
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
mvn test
```

### æ€§èƒ½æµ‹è¯•

```bash
# ä½¿ç”¨MQTTå‹åŠ›æµ‹è¯•å·¥å…·
mosquitto_pub -h localhost -p 23242 -t test/topic -m "Hello World"

# æ‰¹é‡æ¶ˆæ¯æµ‹è¯•
for i in {1..1000}; do
  mosquitto_pub -h localhost -p 23242 -t "test/topic/$i" -m "Message $i"
done
```

### è¿æ¥å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨MQTTå®¢æˆ·ç«¯æ¨¡æ‹Ÿå¤§é‡è¿æ¥
# å»ºè®®ä½¿ç”¨ä¸“ä¸šçš„MQTTå‹åŠ›æµ‹è¯•å·¥å…·
```

### é›†ç¾¤æµ‹è¯•

```bash
# å¯åŠ¨å¤šä¸ªMQTTæœåŠ¡å™¨èŠ‚ç‚¹
# æµ‹è¯•è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ¶ˆæ¯å¤„ç†å™¨

1. å®ç°`MqttMsgListener`æ¥å£
2. åœ¨Springé…ç½®ä¸­æ³¨å†ŒBean
3. é…ç½®æ¶ˆæ¯è·¯ç”±è§„åˆ™

### è‡ªå®šä¹‰æ‹¦æˆªå™¨

1. ç»§æ‰¿`Interceptor`æŠ½è±¡ç±»
2. å®ç°æ¶ˆæ¯è¿‡æ»¤é€»è¾‘
3. åœ¨`MqttServer`ä¸­æ³¨å†Œ

### è‡ªå®šä¹‰æƒé™æ§åˆ¶

1. å®ç°`IAuthorizator`æ¥å£
2. é‡å†™`canRead`å’Œ`canWrite`æ–¹æ³•
3. åœ¨`ProtocolProcessor`ä¸­é…ç½®

### æ‰©å±•æ¶ˆæ¯å¤„ç†

1. ç»§æ‰¿`QosProcessor`ç±»
2. å®ç°è‡ªå®šä¹‰QoSå¤„ç†é€»è¾‘
3. åœ¨`ProtocolProcessor`ä¸­æ³¨å†Œ

### æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†å™¨

1. ç»§æ‰¿`MqttBaseHandler`ç±»
2. å®ç°`handle`æ–¹æ³•
3. åœ¨`MqttMsgProcessThread`ä¸­æ³¨å†Œ

### é›†ç¾¤æ‰©å±•

1. å®ç°è‡ªå®šä¹‰é›†ç¾¤ç›‘æ§é€»è¾‘
2. æ‰©å±•`ClusterServerMonitor`
3. é…ç½®ZooKeeperé›†ç¾¤ä¿¡æ¯

###å¾…å®ç°åŠŸèƒ½
1.æ¶ˆæ¯çš„æŒä¹…åŒ–å­˜å‚¨
2.å®¢æˆ·ç«¯,æµ‹è¯•ç”¨å…¶ä»–çš„mqttå®¢æˆ·ç«¯ä»£æ›¿ï¼ˆæ¯”å¦‚MQTTXï¼‰
3.æ¶ˆæ¯å›è°ƒç›‘å¬å™¨è¿˜å®Œå–„

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) è®¸å¯è¯ã€‚

## ğŸ“ è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…: [Your Name]
- é‚®ç®±: [your.email@example.com]
- é¡¹ç›®åœ°å€: [GitHub Repository URL]

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®çš„æ”¯æŒï¼š
- [Spring Boot](https://spring.io/projects/spring-boot)
- [Netty](https://netty.io/)
- [ZooKeeper](https://zookeeper.apache.org/)
- [Redis](https://redis.io/)

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»åœ¨å¼€å‘ä¸­ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸ç¨³å®šã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚ 